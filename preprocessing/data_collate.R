#### Purpose ####

# Run this script to generate parquet files
# Also includes descriptives from form earlier analyses
# E.g., Q sort segment and mental model scales

#### Load packages ####
library(tidyverse) # for data wrangling
library(lubridate) # for dates
library(arrow) # for cross-language data structures
library(janitor) # for cleaning names

#### Helper functions ####

get_data <- function(study_num) {
    file <- str_c("data/study-", study_num, "-clean.csv")
    if (study_num == 1) {
        specs <- cols(
            time_start = col_datetime(format = ""),
            time_end = col_datetime(format = ""),
            time_to_complete = col_double(),
            specs_Browser = col_character(),
            specs_Version = col_character(),
            specs_Operating.System = col_character(),
            specs_Resolution = col_character(),
            pifFirst.Click = col_logical(),
            pifLast.Click = col_logical(),
            pifPage.Submit = col_logical(),
            pifClick.Count = col_logical(),
            pcf = col_double(),
            pcf_First.Click = col_double(),
            pcf_Last.Click = col_double(),
            pcf_Page.Submit = col_double(),
            pcf_Click.Count = col_double(),
            age = col_double(),
            gender = col_double(),
            demographics_First.Click = col_double(),
            demographics_Last.Click = col_double(),
            demographics_Page.Submit = col_double(),
            demographics_Click.Count = col_double(),
            code_entered = col_character(),
            qualtrics_qsort_First.Click = col_double(),
            qualtrics_qsort_Last.Click = col_double(),
            qualtrics_qsort_Page.Submit = col_double(),
            qualtrics_qsort_Click.Count = col_double(),
            qualtrics_suvery_info_First.Click = col_double(),
            qualtrics_suvery_info_Last.Click = col_double(),
            qualtrics_suvery_info_Page.Submit = col_double(),
            qualtrics_suvery_info_Click.Count = col_double(),
            SS_1 = col_double(),
            SS_2 = col_double(),
            SS_3 = col_double(),
            SS_4 = col_double(),
            SS_5 = col_double(),
            SS_6 = col_double(),
            SS_7 = col_double(),
            SS_8 = col_double(),
            SS_9 = col_double(),
            SS_10 = col_double(),
            SS_11 = col_double(),
            SS_12 = col_double(),
            SS_13 = col_double(),
            SS_14 = col_double(),
            SS_15 = col_double(),
            SS_First.Click = col_double(),
            SS_Last.Click = col_double(),
            SS_Page.Submit = col_double(),
            SS_Click.Count = col_double(),
            PA = col_double(),
            PA_First.Click = col_double(),
            PA_Last.Click = col_double(),
            PA_Page.Submit = col_double(),
            PA_Click.Count = col_double(),
            NCS_6_1 = col_double(),
            NCS_6_2 = col_double(),
            NCS_6_3 = col_double(),
            NCS_6_4 = col_double(),
            NCS_6_5 = col_double(),
            NCS_6_6 = col_double(),
            NCS_6_First.Click = col_double(),
            NCS_6_Last.Click = col_double(),
            NCS_6_Page.Submit = col_double(),
            NCS_6_Click.Count = col_double(),
            MMS_human = col_double(),
            MMS_human_First.Click = col_double(),
            MMS_human_Last.Click = col_double(),
            MMS_human_Page.Submit = col_double(),
            MMS_human_Click.Count = col_double(),
            MMS_cause_1 = col_double(),
            MMS_cause_2 = col_double(),
            MMS_cause_3 = col_double(),
            MMS_cause_4 = col_double(),
            MMS_cause_5 = col_double(),
            MMS_cause_6 = col_double(),
            MMS_cause_7 = col_double(),
            MMS_cause_8 = col_double(),
            MMS_cause_9 = col_double(),
            MMS_cause_10 = col_double(),
            MMS_cause_11 = col_double(),
            MMS_cause_12 = col_double(),
            MMS_cause_13 = col_double(),
            MMS_cause_First.Click = col_double(),
            MMS_cause_Last.Click = col_double(),
            MMS_cause_Page.Submit = col_double(),
            MMS_cause_Click.Count = col_double(),
            MMS_consequence_1 = col_double(),
            MMS_consequence_2 = col_double(),
            MMS_consequence_3 = col_double(),
            MMS_consequence_4 = col_double(),
            MMS_consequence_5 = col_double(),
            MMS_consequence_6 = col_double(),
            MMS_consequence_7 = col_double(),
            MMS_consequence_8 = col_double(),
            MMS_consequence_9 = col_double(),
            MMS_consequence_10 = col_double(),
            MMS_consequence_11 = col_double(),
            MMS_consequence_First.Click = col_double(),
            MMS_consequence_Last.Click = col_double(),
            MMS_consequence_Page.Submit = col_double(),
            MMS_consequence_Click.Count = col_double(),
            MMS_mitigation_1 = col_double(),
            MMS_mitigation_2 = col_double(),
            MMS_mitigation_3 = col_double(),
            MMS_mitigation_4 = col_double(),
            MMS_mitigation_5 = col_double(),
            MMS_mitigation_6 = col_double(),
            MMS_mitigation_7 = col_double(),
            MMS_mitigation_8 = col_double(),
            MMS_mitigation_9 = col_double(),
            MMS_mitigation_10 = col_double(),
            MMS_mitigation_11 = col_double(),
            MMS_mitigation_First.Click = col_double(),
            MMS_mitigation_Last.Click = col_double(),
            MMS_mitigation_Page.Submit = col_double(),
            MMS_mitigation_Click.Count = col_double(),
            SVSS_1 = col_double(),
            SVSS_2 = col_double(),
            SVSS_3 = col_double(),
            SVSS_4 = col_double(),
            SVSS_5 = col_double(),
            SVSS_6 = col_double(),
            SVSS_7 = col_double(),
            SVSS_8 = col_double(),
            SVSS_9 = col_double(),
            SVSS_10 = col_double(),
            SVSS_First.Click = col_double(),
            SVSS_Last.Click = col_double(),
            SVSS_Page.Submit = col_double(),
            SVSS_Click.Count = col_double(),
            KV = col_double(),
            KV_First.Click = col_double(),
            KV_Last.Click = col_double(),
            KV_Page.Submit = col_double(),
            KV_Click.Count = col_double(),
            SJ_1 = col_double(),
            SJ_2 = col_double(),
            SJ_3 = col_double(),
            SJ_4 = col_double(),
            SJ_5 = col_double(),
            SJ_6 = col_double(),
            SJ_7 = col_double(),
            SJ_8 = col_double(),
            SJ_First.Click = col_double(),
            SJ_Last.Click = col_double(),
            SJ_Page.Submit = col_double(),
            SJ_Click.Count = col_double(),
            CI_1 = col_double(),
            CI_2 = col_double(),
            CI_3 = col_double(),
            CI_4 = col_double(),
            CI_5 = col_double(),
            CI_6 = col_double(),
            CI_First.Click = col_double(),
            CI_Last.Click = col_double(),
            CI_Page.Submit = col_double(),
            CI_Click.Count = col_double(),
            W = col_double(),
            W_First.Click = col_double(),
            W_Last.Click = col_double(),
            W_Page.Submit = col_double(),
            W_Click.Count = col_double(),
            CFC_S_1 = col_double(),
            CFC_S_2 = col_double(),
            CFC_S_3 = col_double(),
            CFC_S_4 = col_double(),
            CFC_S_5 = col_double(),
            CFC_S_6 = col_double(),
            CFC_S_7 = col_double(),
            CFC_S_8 = col_double(),
            CFC_S_9 = col_double(),
            CFC_S_First.Click = col_double(),
            CFC_S_Last.Click = col_double(),
            CFC_S_Page.Submit = col_double(),
            CFC_S_Click.Count = col_double(),
            BFI_10_1 = col_double(),
            BFI_10_2 = col_double(),
            BFI_10_3 = col_double(),
            BFI_10_4 = col_double(),
            BFI_10_5 = col_double(),
            BFI_10_6 = col_double(),
            BFI_10_7 = col_double(),
            BFI_10_8 = col_double(),
            BFI_10_9 = col_double(),
            BFI_10_10 = col_double(),
            BFI_10_First.Click = col_double(),
            BFI_10_Last.Click = col_double(),
            BFI_10_Page.Submit = col_double(),
            BFI_10_Click.Count = col_double(),
            EWS_1 = col_double(),
            EWS_2 = col_double(),
            EWS_3 = col_double(),
            EWS_4 = col_double(),
            EWS_5 = col_double(),
            EWS_6 = col_double(),
            EWS_7 = col_double(),
            EWS_8 = col_double(),
            EWS_9 = col_double(),
            EWS_10 = col_double(),
            EWS_11 = col_double(),
            EWS_12 = col_double(),
            EWS_First.Click = col_double(),
            EWS_Last.Click = col_double(),
            EWS_Page.Submit = col_double(),
            EWS_Click.Count = col_double(),
            qualtrics_qsort_id = col_character(),
            latin = col_double(),
            Lucid = col_character(),
            term = col_logical(),
            AgeGroup = col_character(),
            Group = col_double(),
            LS = col_character(),
            id = col_double(),
            completion_order = col_double(),
            pref_sta_1 = col_character(),
            pref_sta_2 = col_character(),
            pref_sta_3 = col_character(),
            pref_sta_4 = col_character(),
            pref_sta_5 = col_character(),
            pref_sta_6 = col_character(),
            pref_sta_7 = col_character(),
            pref_sta_8 = col_character(),
            pref_sta_9 = col_character(),
            pref_sta_10 = col_character(),
            pref_sta_11 = col_character(),
            pref_sta_12 = col_character(),
            pref_sta_13 = col_character(),
            pref_sta_14 = col_character(),
            pref_sta_15 = col_character(),
            pref_sta_16 = col_character(),
            pref_sta_17 = col_character(),
            pref_sta_18 = col_character(),
            pref_sta_19 = col_character(),
            pref_sta_20 = col_character(),
            pref_sta_21 = col_character(),
            pref_sta_22 = col_character(),
            pref_sta_23 = col_character(),
            pref_sta_24 = col_character(),
            pref_sta_25 = col_character(),
            pref_sta_26 = col_character(),
            pref_sta_27 = col_character(),
            pref_sta_28 = col_character(),
            pref_sta_29 = col_character(),
            pref_sta_30 = col_character(),
            reason_sta_1 = col_character(),
            reason_sta_2 = col_character(),
            reason_sta_3 = col_character(),
            reason_sta_4 = col_character(),
            reason_sta_5 = col_character(),
            reason_sta_6 = col_character(),
            reason_sta_7 = col_character(),
            reason_sta_8 = col_character(),
            reason_sta_9 = col_character(),
            reason_sta_10 = col_character(),
            reason_sta_11 = col_character(),
            reason_sta_12 = col_character(),
            reason_sta_13 = col_character(),
            reason_sta_14 = col_character(),
            reason_sta_15 = col_character(),
            reason_sta_16 = col_character(),
            reason_sta_17 = col_character(),
            reason_sta_18 = col_character(),
            reason_sta_19 = col_character(),
            reason_sta_20 = col_character(),
            reason_sta_21 = col_character(),
            reason_sta_22 = col_character(),
            reason_sta_23 = col_character(),
            reason_sta_24 = col_character(),
            reason_sta_25 = col_character(),
            reason_sta_26 = col_character(),
            reason_sta_27 = col_character(),
            reason_sta_28 = col_character(),
            reason_sta_29 = col_character(),
            reason_sta_30 = col_character(),
            sort_sta_1 = col_character(),
            sort_sta_2 = col_character(),
            sort_sta_3 = col_character(),
            sort_sta_4 = col_character(),
            sort_sta_5 = col_character(),
            sort_sta_6 = col_character(),
            sort_sta_7 = col_character(),
            sort_sta_8 = col_character(),
            sort_sta_9 = col_character(),
            sort_sta_10 = col_character(),
            sort_sta_11 = col_character(),
            sort_sta_12 = col_character(),
            sort_sta_13 = col_character(),
            sort_sta_14 = col_character(),
            sort_sta_15 = col_character(),
            sort_sta_16 = col_character(),
            sort_sta_17 = col_character(),
            sort_sta_18 = col_character(),
            sort_sta_19 = col_character(),
            sort_sta_20 = col_character(),
            sort_sta_21 = col_character(),
            sort_sta_22 = col_character(),
            sort_sta_23 = col_character(),
            sort_sta_24 = col_character(),
            sort_sta_25 = col_character(),
            sort_sta_26 = col_character(),
            sort_sta_27 = col_character(),
            sort_sta_28 = col_character(),
            sort_sta_29 = col_character(),
            sort_sta_30 = col_character(),
            time_instruct = col_double(),
            time_pilot = col_double(),
            time_pref = col_double(),
            time_reason = col_double(),
            time_sort = col_double(),
            count_noroom = col_double(),
            count_incon = col_double(),
            supress_noroom = col_logical(),
            supress_incon = col_logical(),
            pilot_response1 = col_logical(),
            pilot_response2 = col_logical(),
            place_grid = col_double(),
            place_avail = col_double(),
            place_spare = col_double(),
            place_spare_max = col_double(),
            qs = col_character(),
            pass = col_character(),
            time_start_qsort = col_datetime(format = "")
        )
    }
    if (study_num == 2) {
        specs <- cols(
            time_start = col_datetime(format = ""),
            time_end = col_datetime(format = ""),
            time_to_complete = col_double(),
            specs_BROWSER = col_character(),
            specs_VERSION = col_character(),
            specs_OS = col_character(),
            specs_RESOLUTION = col_character(),
            QID100_FIRST_CLICK = col_logical(),
            QID100_LAST_CLICK = col_logical(),
            QID100_PAGE_SUBMIT = col_logical(),
            QID100_CLICK_COUNT = col_logical(),
            pcf = col_double(),
            pif_FIRST_CLICK = col_double(),
            pif_LAST_CLICK = col_double(),
            pif_PAGE_SUBMIT = col_double(),
            pif_CLICK_COUNT = col_double(),
            age = col_double(),
            gender = col_double(),
            demographics_FIRST_CLICK = col_double(),
            demographics_LAST_CLICK = col_double(),
            demographics_PAGE_SUBMIT = col_double(),
            demographics_CLICK_COUNT = col_double(),
            code_entered = col_character(),
            qualtrics_qsort_FIRST_CLICK = col_double(),
            qualtrics_qsort_LAST_CLICK = col_double(),
            qualtrics_qsort_PAGE_SUBMIT = col_double(),
            qualtrics_qsort_CLICK_COUNT = col_double(),
            qualtrics_suvery_info_FIRST_CLICK = col_double(),
            qualtrics_suvery_info_LAST_CLICK = col_double(),
            qualtrics_suvery_info_PAGE_SUBMIT = col_double(),
            qualtrics_suvery_info_CLICK_COUNT = col_double(),
            trust_sci = col_double(),
            trust_cat = col_double(),
            trust_FIRST_CLICK = col_double(),
            trust_LAST_CLICK = col_double(),
            trust_PAGE_SUBMIT = col_double(),
            trust_CLICK_COUNT = col_double(),
            cause_emissions_pre_1_1 = col_double(),
            cause_emissions_pre_2_1 = col_double(),
            cause_emissions_pre_3_1 = col_double(),
            cause_emissions_pre_4_1 = col_double(),
            cause_emissions_pre_5_1 = col_double(),
            cause_emissions_pre_6_1 = col_double(),
            cause_emissions_pre_FIRST_CLICK = col_double(),
            cause_emissions_pre_LAST_CLICK = col_double(),
            cause_emissions_pre_PAGE_SUBMIT = col_double(),
            cause_emissions_pre_CLICK_COUNT = col_double(),
            cause_emissions_post_1_1 = col_double(),
            cause_emissions_post_2_1 = col_double(),
            cause_emissions_post_3_1 = col_double(),
            cause_emissions_post_4_1 = col_double(),
            cause_emissions_post_5_1 = col_double(),
            cause_emissions_post_6_1 = col_double(),
            cause_emissions_post_FIRST_CLICK = col_double(),
            cause_emissions_post_LAST_CLICK = col_double(),
            cause_emissions_post_PAGE_SUBMIT = col_double(),
            cause_emissions_post_CLICK_COUNT = col_double(),
            cause_activity_pre_1_1 = col_double(),
            cause_activity_pre_2_1 = col_double(),
            cause_activity_pre_3_1 = col_double(),
            cause_activity_pre_4_1 = col_double(),
            cause_activity_pre_5_1 = col_double(),
            cause_activity_pre_6_1 = col_double(),
            cause_activity_post_1_1 = col_double(),
            cause_activity_post_2_1 = col_double(),
            cause_activity_post_3_1 = col_double(),
            cause_activity_post_4_1 = col_double(),
            cause_activity_post_5_1 = col_double(),
            cause_activity_post_6_1 = col_double(),
            cause_activity_post_FIRST_CLICK = col_double(),
            cause_activity_post_LAST_CLICK = col_double(),
            cause_activity_post_PAGE_SUBMIT = col_double(),
            cause_activity_post_CLICK_COUNT = col_double(),
            conseq_pre_1_1 = col_double(),
            conseq_pre_17_1 = col_double(),
            conseq_pre_18_1 = col_double(),
            conseq_pre_39_1 = col_double(),
            conseq_pre_56_1 = col_double(),
            conseq_pre_40_1 = col_double(),
            conseq_pre_41_1 = col_double(),
            conseq_pre_42_1 = col_double(),
            conseq_pre_43_1 = col_double(),
            conseq_pre_FIRST_CLICK = col_double(),
            conseq_pre_LAST_CLICK = col_double(),
            conseq_pre_PAGE_SUBMIT = col_double(),
            conseq_pre_CLICK_COUNT = col_double(),
            conseq_post_1_1 = col_double(),
            conseq_post_17_1 = col_double(),
            conseq_post_18_1 = col_double(),
            conseq_post_39_1 = col_double(),
            conseq_post_56_1 = col_double(),
            conseq_post_40_1 = col_double(),
            conseq_post_41_1 = col_double(),
            conseq_post_42_1 = col_double(),
            conseq_post_43_1 = col_double(),
            conseq_post_FIRST_CLICK = col_double(),
            conseq_post_LAST_CLICK = col_double(),
            conseq_post_PAGE_SUBMIT = col_double(),
            conseq_post_CLICK_COUNT = col_double(),
            cause_gen_pre_1_1 = col_double(),
            cause_gen_pre_2_1 = col_double(),
            cause_gen_pre_FIRST_CLICK = col_double(),
            cause_gen_pre_LAST_CLICK = col_double(),
            cause_gen_pre_PAGE_SUBMIT = col_double(),
            cause_gen_pre_CLICK_COUNT = col_double(),
            cause_gen_post_1_1 = col_double(),
            cause_gen_post_2_1 = col_double(),
            cause_gen_post_FIRST_CLICK = col_double(),
            cause_gen_post_LAST_CLICK = col_double(),
            cause_gen_post_PAGE_SUBMIT = col_double(),
            cause_gen_post_CLICK_COUNT = col_double(),
            mitig_approve_pre_1 = col_double(),
            mitig_approve_pre_2 = col_double(),
            mitig_success_pre = col_double(),
            mitig_direction_pre = col_double(),
            mitig_amount_pre = col_double(),
            mitig_pre_FIRST_CLICK = col_double(),
            mitig_pre_LAST_CLICK = col_double(),
            mitig_pre_PAGE_SUBMIT = col_double(),
            mitig_pre_CLICK_COUNT = col_double(),
            mitig_approve_post_1 = col_double(),
            mitig_approve_post_2 = col_double(),
            mitig_success_post = col_double(),
            mitig_direction_1_post = col_double(),
            mitig_amount_1_post = col_double(),
            mitig_direction_2_post = col_double(),
            mitig_amount_2_post = col_double(),
            mitig_post_FIRST_CLICK = col_double(),
            mitig_post_LAST_CLICK = col_double(),
            mitig_post_PAGE_SUBMIT = col_double(),
            mitig_post_CLICK_COUNT = col_double(),
            conseq_sentiment_1 = col_double(),
            conseq_sentiment_14 = col_double(),
            conseq_sentiment_15 = col_double(),
            conseq_sentiment_16 = col_double(),
            conseq_sentiment_17 = col_double(),
            conseq_sentiment_18 = col_double(),
            conseq_sentiment_19 = col_double(),
            conseq_sentiment_20 = col_double(),
            conseq_sentiment_21 = col_double(),
            conseq_sentiment_FIRST_CLICK = col_double(),
            conseq_sentiment_LAST_CLICK = col_double(),
            conseq_sentiment_PAGE_SUBMIT = col_double(),
            conseq_sentiment_CLICK_COUNT = col_double(),
            mitig_sentiment = col_double(),
            mitig_sentiment_FIRST_CLICK = col_double(),
            mitig_sentiment_LAST_CLICK = col_double(),
            mitig_sentiment_PAGE_SUBMIT = col_double(),
            mitig_sentiment_CLICK_COUNT = col_double(),
            condition = col_double(),
            qualtrics_qsort_id = col_character(),
            ls = col_double(),
            id = col_double(),
            completion_order = col_double(),
            pref_sta_1 = col_character(),
            pref_sta_2 = col_character(),
            pref_sta_3 = col_character(),
            pref_sta_4 = col_character(),
            pref_sta_5 = col_character(),
            pref_sta_6 = col_character(),
            pref_sta_7 = col_character(),
            pref_sta_8 = col_character(),
            pref_sta_9 = col_character(),
            pref_sta_10 = col_character(),
            pref_sta_11 = col_character(),
            pref_sta_12 = col_character(),
            pref_sta_13 = col_character(),
            pref_sta_14 = col_character(),
            pref_sta_15 = col_character(),
            pref_sta_16 = col_character(),
            pref_sta_17 = col_character(),
            pref_sta_18 = col_character(),
            pref_sta_19 = col_character(),
            pref_sta_20 = col_character(),
            pref_sta_21 = col_character(),
            pref_sta_22 = col_character(),
            pref_sta_23 = col_character(),
            pref_sta_24 = col_character(),
            pref_sta_25 = col_character(),
            pref_sta_26 = col_character(),
            pref_sta_27 = col_character(),
            pref_sta_28 = col_character(),
            pref_sta_29 = col_character(),
            pref_sta_30 = col_character(),
            reason_sta_1 = col_character(),
            reason_sta_2 = col_character(),
            reason_sta_3 = col_character(),
            reason_sta_4 = col_character(),
            reason_sta_5 = col_character(),
            reason_sta_6 = col_character(),
            reason_sta_7 = col_character(),
            reason_sta_8 = col_character(),
            reason_sta_9 = col_character(),
            reason_sta_10 = col_character(),
            reason_sta_11 = col_character(),
            reason_sta_12 = col_character(),
            reason_sta_13 = col_character(),
            reason_sta_14 = col_character(),
            reason_sta_15 = col_character(),
            reason_sta_16 = col_character(),
            reason_sta_17 = col_character(),
            reason_sta_18 = col_character(),
            reason_sta_19 = col_character(),
            reason_sta_20 = col_character(),
            reason_sta_21 = col_character(),
            reason_sta_22 = col_character(),
            reason_sta_23 = col_character(),
            reason_sta_24 = col_character(),
            reason_sta_25 = col_character(),
            reason_sta_26 = col_character(),
            reason_sta_27 = col_character(),
            reason_sta_28 = col_character(),
            reason_sta_29 = col_character(),
            reason_sta_30 = col_character(),
            sort_sta_1 = col_character(),
            sort_sta_2 = col_character(),
            sort_sta_3 = col_character(),
            sort_sta_4 = col_character(),
            sort_sta_5 = col_character(),
            sort_sta_6 = col_character(),
            sort_sta_7 = col_character(),
            sort_sta_8 = col_character(),
            sort_sta_9 = col_character(),
            sort_sta_10 = col_character(),
            sort_sta_11 = col_character(),
            sort_sta_12 = col_character(),
            sort_sta_13 = col_character(),
            sort_sta_14 = col_character(),
            sort_sta_15 = col_character(),
            sort_sta_16 = col_character(),
            sort_sta_17 = col_character(),
            sort_sta_18 = col_character(),
            sort_sta_19 = col_character(),
            sort_sta_20 = col_character(),
            sort_sta_21 = col_character(),
            sort_sta_22 = col_character(),
            sort_sta_23 = col_character(),
            sort_sta_24 = col_character(),
            sort_sta_25 = col_character(),
            sort_sta_26 = col_character(),
            sort_sta_27 = col_character(),
            sort_sta_28 = col_character(),
            sort_sta_29 = col_character(),
            sort_sta_30 = col_character(),
            time_instruct = col_double(),
            time_pilot = col_double(),
            time_pref = col_double(),
            time_reason = col_double(),
            time_sort = col_double(),
            count_noroom = col_double(),
            count_incon = col_double(),
            supress_noroom = col_logical(),
            supress_incon = col_logical(),
            pilot_response1 = col_logical(),
            pilot_response2 = col_logical(),
            place_grid = col_double(),
            place_avail = col_double(),
            place_spare = col_double(),
            place_spare_max = col_double(),
            qs = col_character(),
            pass = col_character(),
            time_start_qsort = col_datetime(format = "")
        )
    }
    if (study_num == 3) {
        specs <- cols(
            time_start = col_datetime(format = ""),
            time_end = col_datetime(format = ""),
            time_to_complete = col_double(),
            specs_Browser = col_character(),
            specs_Version = col_character(),
            specs_Operating.System = col_character(),
            specs_Resolution = col_character(),
            pifFirst.Click = col_logical(),
            pifLast.Click = col_logical(),
            pifPage.Submit = col_logical(),
            pifClick.Count = col_logical(),
            pcf = col_double(),
            pcf_First.Click = col_double(),
            pcf_Last.Click = col_double(),
            pcf_Page.Submit = col_double(),
            pcf_Click.Count = col_double(),
            age = col_double(),
            gender = col_double(),
            demographics_First.Click = col_double(),
            demographics_Last.Click = col_double(),
            demographics_Page.Submit = col_double(),
            demographics_Click.Count = col_double(),
            FPS_1 = col_double(),
            FPS_2 = col_double(),
            FPS_3 = col_double(),
            FPS_4 = col_double(),
            FPS_5 = col_double(),
            FPS_6 = col_double(),
            FPS_7 = col_double(),
            FP_mitigation = col_double(),
            FP_mitigation_text = col_character(),
            code_entered = col_character(),
            qualtrics_qsort_First.Click = col_double(),
            qualtrics_qsort_Last.Click = col_double(),
            qualtrics_qsort_Page.Submit = col_double(),
            qualtrics_qsort_Click.Count = col_double(),
            qualtrics_suvery_info_First.Click = col_double(),
            qualtrics_suvery_info_Last.Click = col_double(),
            qualtrics_suvery_info_Page.Submit = col_double(),
            qualtrics_suvery_info_Click.Count = col_double(),
            SS_1 = col_double(),
            SS_2 = col_double(),
            SS_3 = col_double(),
            SS_4 = col_double(),
            SS_5 = col_double(),
            SS_6 = col_double(),
            SS_7 = col_double(),
            SS_8 = col_double(),
            SS_9 = col_double(),
            SS_10 = col_double(),
            SS_11 = col_double(),
            SS_12 = col_double(),
            SS_13 = col_double(),
            SS_14 = col_double(),
            SS_15 = col_double(),
            SS_First.Click = col_double(),
            SS_Last.Click = col_double(),
            SS_Page.Submit = col_double(),
            SS_Click.Count = col_double(),
            PA = col_double(),
            PA_First.Click = col_double(),
            PA_Last.Click = col_double(),
            PA_Page.Submit = col_double(),
            PA_Click.Count = col_double(),
            NCS_6_1 = col_double(),
            NCS_6_2 = col_double(),
            NCS_6_3 = col_double(),
            NCS_6_4 = col_double(),
            NCS_6_5 = col_double(),
            NCS_6_6 = col_double(),
            NCS_6_First.Click = col_double(),
            NCS_6_Last.Click = col_double(),
            NCS_6_Page.Submit = col_double(),
            NCS_6_Click.Count = col_double(),
            MMS_human = col_double(),
            MMS_human_First.Click = col_double(),
            MMS_human_Last.Click = col_double(),
            MMS_human_Page.Submit = col_double(),
            MMS_human_Click.Count = col_double(),
            MMS_cause_1 = col_double(),
            MMS_cause_2 = col_double(),
            MMS_cause_3 = col_double(),
            MMS_cause_4 = col_double(),
            MMS_cause_5 = col_double(),
            MMS_cause_6 = col_double(),
            MMS_cause_7 = col_double(),
            MMS_cause_8 = col_double(),
            MMS_cause_9 = col_double(),
            MMS_cause_10 = col_double(),
            MMS_cause_11 = col_double(),
            MMS_cause_12 = col_double(),
            MMS_cause_13 = col_double(),
            MMS_cause_First.Click = col_double(),
            MMS_cause_Last.Click = col_double(),
            MMS_cause_Page.Submit = col_double(),
            MMS_cause_Click.Count = col_double(),
            MMS_consequence_1 = col_double(),
            MMS_consequence_2 = col_double(),
            MMS_consequence_3 = col_double(),
            MMS_consequence_4 = col_double(),
            MMS_consequence_5 = col_double(),
            MMS_consequence_6 = col_double(),
            MMS_consequence_7 = col_double(),
            MMS_consequence_8 = col_double(),
            MMS_consequence_9 = col_double(),
            MMS_consequence_10 = col_double(),
            MMS_consequence_11 = col_double(),
            MMS_consequence_First.Click = col_double(),
            MMS_consequence_Last.Click = col_double(),
            MMS_consequence_Page.Submit = col_double(),
            MMS_consequence_Click.Count = col_double(),
            MMS_mitigation_1 = col_double(),
            MMS_mitigation_2 = col_double(),
            MMS_mitigation_3 = col_double(),
            MMS_mitigation_4 = col_double(),
            MMS_mitigation_5 = col_double(),
            MMS_mitigation_6 = col_double(),
            MMS_mitigation_7 = col_double(),
            MMS_mitigation_8 = col_double(),
            MMS_mitigation_9 = col_double(),
            MMS_mitigation_10 = col_double(),
            MMS_mitigation_11 = col_double(),
            MMS_mitigation_First.Click = col_double(),
            MMS_mitigation_Last.Click = col_double(),
            MMS_mitigation_Page.Submit = col_double(),
            MMS_mitigation_Click.Count = col_double(),
            SVSS_1 = col_double(),
            SVSS_2 = col_double(),
            SVSS_3 = col_double(),
            SVSS_4 = col_double(),
            SVSS_5 = col_double(),
            SVSS_6 = col_double(),
            SVSS_7 = col_double(),
            SVSS_8 = col_double(),
            SVSS_9 = col_double(),
            SVSS_10 = col_double(),
            SVSS_First.Click = col_double(),
            SVSS_Last.Click = col_double(),
            SVSS_Page.Submit = col_double(),
            SVSS_Click.Count = col_double(),
            KV = col_double(),
            KV_First.Click = col_double(),
            KV_Last.Click = col_double(),
            KV_Page.Submit = col_double(),
            KV_Click.Count = col_double(),
            SJ_1 = col_double(),
            SJ_2 = col_double(),
            SJ_3 = col_double(),
            SJ_4 = col_double(),
            SJ_5 = col_double(),
            SJ_6 = col_double(),
            SJ_7 = col_double(),
            SJ_8 = col_double(),
            SJ_First.Click = col_double(),
            SJ_Last.Click = col_double(),
            SJ_Page.Submit = col_double(),
            SJ_Click.Count = col_double(),
            CI_1 = col_double(),
            CI_2 = col_double(),
            CI_3 = col_double(),
            CI_4 = col_double(),
            CI_5 = col_double(),
            CI_6 = col_double(),
            CI_First.Click = col_double(),
            CI_Last.Click = col_double(),
            CI_Page.Submit = col_double(),
            CI_Click.Count = col_double(),
            W = col_double(),
            W_First.Click = col_double(),
            W_Last.Click = col_double(),
            W_Page.Submit = col_double(),
            W_Click.Count = col_double(),
            CFC_S_1 = col_double(),
            CFC_S_2 = col_double(),
            CFC_S_3 = col_double(),
            CFC_S_4 = col_double(),
            CFC_S_5 = col_double(),
            CFC_S_6 = col_double(),
            CFC_S_7 = col_double(),
            CFC_S_8 = col_double(),
            CFC_S_9 = col_double(),
            CFC_S_First.Click = col_double(),
            CFC_S_Last.Click = col_double(),
            CFC_S_Page.Submit = col_double(),
            CFC_S_Click.Count = col_double(),
            BFI_10_1 = col_double(),
            BFI_10_2 = col_double(),
            BFI_10_3 = col_double(),
            BFI_10_4 = col_double(),
            BFI_10_5 = col_double(),
            BFI_10_6 = col_double(),
            BFI_10_7 = col_double(),
            BFI_10_8 = col_double(),
            BFI_10_9 = col_double(),
            BFI_10_10 = col_double(),
            BFI_10_First.Click = col_double(),
            BFI_10_Last.Click = col_double(),
            BFI_10_Page.Submit = col_double(),
            BFI_10_Click.Count = col_double(),
            EWS_1 = col_double(),
            EWS_2 = col_double(),
            EWS_3 = col_double(),
            EWS_4 = col_double(),
            EWS_5 = col_double(),
            EWS_6 = col_double(),
            EWS_7 = col_double(),
            EWS_8 = col_double(),
            EWS_9 = col_double(),
            EWS_10 = col_double(),
            EWS_11 = col_double(),
            EWS_12 = col_double(),
            EWS_First.Click = col_double(),
            EWS_Last.Click = col_double(),
            EWS_Page.Submit = col_double(),
            EWS_Click.Count = col_double(),
            qualtrics_qsort_id = col_character(),
            latin = col_double(),
            Lucid = col_logical(),
            firesfirst = col_double(),
            ResponseID = col_character(),
            term = col_logical(),
            AgeGroup = col_character(),
            Group = col_double(),
            LS = col_double(),
            id = col_double(),
            completion_order = col_double(),
            pref_sta_1 = col_character(),
            pref_sta_2 = col_character(),
            pref_sta_3 = col_character(),
            pref_sta_4 = col_character(),
            pref_sta_5 = col_character(),
            pref_sta_6 = col_character(),
            pref_sta_7 = col_character(),
            pref_sta_8 = col_character(),
            pref_sta_9 = col_character(),
            pref_sta_10 = col_character(),
            pref_sta_11 = col_character(),
            pref_sta_12 = col_character(),
            pref_sta_13 = col_character(),
            pref_sta_14 = col_character(),
            pref_sta_15 = col_character(),
            pref_sta_16 = col_character(),
            pref_sta_17 = col_character(),
            pref_sta_18 = col_character(),
            pref_sta_19 = col_character(),
            pref_sta_20 = col_character(),
            pref_sta_21 = col_character(),
            pref_sta_22 = col_character(),
            pref_sta_23 = col_character(),
            pref_sta_24 = col_character(),
            pref_sta_25 = col_character(),
            pref_sta_26 = col_character(),
            pref_sta_27 = col_character(),
            pref_sta_28 = col_character(),
            pref_sta_29 = col_character(),
            pref_sta_30 = col_character(),
            reason_sta_1 = col_character(),
            reason_sta_2 = col_character(),
            reason_sta_3 = col_character(),
            reason_sta_4 = col_character(),
            reason_sta_5 = col_character(),
            reason_sta_6 = col_character(),
            reason_sta_7 = col_character(),
            reason_sta_8 = col_character(),
            reason_sta_9 = col_character(),
            reason_sta_10 = col_character(),
            reason_sta_11 = col_character(),
            reason_sta_12 = col_character(),
            reason_sta_13 = col_character(),
            reason_sta_14 = col_character(),
            reason_sta_15 = col_character(),
            reason_sta_16 = col_character(),
            reason_sta_17 = col_character(),
            reason_sta_18 = col_character(),
            reason_sta_19 = col_character(),
            reason_sta_20 = col_character(),
            reason_sta_21 = col_character(),
            reason_sta_22 = col_character(),
            reason_sta_23 = col_character(),
            reason_sta_24 = col_character(),
            reason_sta_25 = col_character(),
            reason_sta_26 = col_character(),
            reason_sta_27 = col_character(),
            reason_sta_28 = col_character(),
            reason_sta_29 = col_character(),
            reason_sta_30 = col_character(),
            sort_sta_1 = col_character(),
            sort_sta_2 = col_character(),
            sort_sta_3 = col_character(),
            sort_sta_4 = col_character(),
            sort_sta_5 = col_character(),
            sort_sta_6 = col_character(),
            sort_sta_7 = col_character(),
            sort_sta_8 = col_character(),
            sort_sta_9 = col_character(),
            sort_sta_10 = col_character(),
            sort_sta_11 = col_character(),
            sort_sta_12 = col_character(),
            sort_sta_13 = col_character(),
            sort_sta_14 = col_character(),
            sort_sta_15 = col_character(),
            sort_sta_16 = col_character(),
            sort_sta_17 = col_character(),
            sort_sta_18 = col_character(),
            sort_sta_19 = col_character(),
            sort_sta_20 = col_character(),
            sort_sta_21 = col_character(),
            sort_sta_22 = col_character(),
            sort_sta_23 = col_character(),
            sort_sta_24 = col_character(),
            sort_sta_25 = col_character(),
            sort_sta_26 = col_character(),
            sort_sta_27 = col_character(),
            sort_sta_28 = col_character(),
            sort_sta_29 = col_character(),
            sort_sta_30 = col_character(),
            time_instruct = col_double(),
            time_pilot = col_double(),
            time_pref = col_double(),
            time_reason = col_double(),
            time_sort = col_double(),
            count_noroom = col_double(),
            count_incon = col_double(),
            supress_noroom = col_logical(),
            supress_incon = col_logical(),
            pilot_response1 = col_logical(),
            pilot_response2 = col_logical(),
            place_grid = col_double(),
            place_avail = col_double(),
            place_spare = col_double(),
            place_spare_max = col_double(),
            qs = col_character(),
            pass = col_character(),
            time_start_qsort = col_datetime(format = ""))
    }

    data <- read_csv(file, col_types = specs, locale = locale(encoding = "UTF-8"))
    
    if ("LS" %in% names(data)) {
        data <- data |>
            select(-LS) # not equivalent to ls in other studies
    }

    data <- data |>
        mutate(study = study_num)

    data <- data |>
        janitor::clean_names() |>
        rename_with(str_to_lower)

    return(data)
}

rev_score <- function(score, max, min) {
    # Reverse scores data, given score and a maximum and minimum of total scale
    if (missing(min)) {
        min <- 1
    }
    return(max - score + min)
}

# Load data from all studies
data <- 1:3 |>
    map(get_data) |>
    bind_rows()

# Recode some variable types
data <- data |>
    mutate(id = as.integer(id))

# Select variables measured in bushfire study
vars_relevant <- data |>
    group_by(study) |>
    summarise(across(everything(), ~ sum(!is.na(.)))) |>
    filter(study == 3) |>
    ungroup() |>
    pivot_longer(-study) |>
    filter(value > 0) |>
    pull(name)
data <- data |>
    select(all_of(c(vars_relevant, "study")))

# Filter fast responders
fast_responders <- tibble(
    study = 1:3,
    fast_response = c(872.5, 664, 509) 
)
data <- data |>
    left_join(fast_responders, by = "study") |>
    filter(time_to_complete >= fast_response)

# Recode SVSS from 1->9 to 0->8
data <- data |>
    mutate(across(matches("^svss_[0-9]+"), ~ .x - 1))

# Calculate composite scores for auxiliary psychometric measures
data <- data |>
    group_by(study, id) |>
    mutate(bfi_e = mean(c(rev_score(bfi_10_1, 5), bfi_10_6))) |>
    mutate(bfi_a = mean(c(rev_score(bfi_10_7, 5), bfi_10_2))) |>
    mutate(bfi_c = mean(c(rev_score(bfi_10_3, 5), bfi_10_8))) |>
    mutate(bfi_n = mean(c(rev_score(bfi_10_4, 5), bfi_10_9))) |>
    mutate(bfi_o = mean(c(rev_score(bfi_10_5, 5), bfi_10_10))) |>
    mutate(cfc_f = mean(c(cfc_s_1, cfc_s_2, cfc_s_5, cfc_s_6))) |>
    mutate(cfc_i = mean(c(cfc_s_3, cfc_s_4, cfc_s_7, cfc_s_8, cfc_s_9))) |>
    mutate(ci = mean(c(ci_1, ci_2, ci_3, ci_4, ci_5, ci_6))) |>
    mutate(ews_e = mean(c(ews_1, ews_3, ews_5, ews_6, ews_7, ews_10))) |>
    mutate(ews_d = mean(c(ews_2, ews_4, ews_8, ews_9, ews_11, ews_12))) |>
    mutate(ncs = mean(c(ncs_6_1, ncs_6_2, rev_score(ncs_6_3, 5), rev_score(ncs_6_4, 5), ncs_6_5, ncs_6_6))) |>
    mutate(sj = mean(c(sj_1, sj_2, rev_score(sj_3, 9), sj_4, sj_5, sj_6, rev_score(sj_7, 9), sj_8))) |>
    mutate(ss_e = mean(c(ss_1, ss_2, ss_4, ss_5, ss_8, ss_9, ss_13, ss_15))) |>
    mutate(ss_r = mean(c(ss_3, ss_6, ss_7, ss_10, ss_11, ss_12, ss_14))) |>
    mutate(svss_c = .82+.05*svss_1+.06*svss_2-.04*svss_3-.09*svss_4-.18*svss_5-.16*svss_6+.03*svss_7+.16*svss_8+.18*svss_9+.11*svss_10) |>
    mutate(svss_st = -0.60-.19*svss_1-.14*svss_2-.09*svss_3-.11*svss_4+.01*svss_5+.10*svss_6+.13*svss_7+.07*svss_8+.06*svss_9+.02*svss_10) |>
    mutate(mms_con_p = mean(c(mms_consequence_2, mms_consequence_6, mms_consequence_11))) |>
    mutate(mms_con_s = mean(c(mms_consequence_1, mms_consequence_3, mms_consequence_4, mms_consequence_5, mms_consequence_7, mms_consequence_8, mms_consequence_9, mms_consequence_10))) |>
    mutate(mms_mit_c = 7 - mean(c(mms_mitigation_1, mms_mitigation_7, mms_mitigation_8)) + 1) |>
    mutate(mms_mit_e = 7 - mean(c(mms_mitigation_2, mms_mitigation_5, mms_mitigation_10)) + 1) |>
    mutate(mms_mit_g = 7 - mean(c(mms_mitigation_3, mms_mitigation_4, mms_mitigation_6, mms_mitigation_9, mms_mitigation_11)) + 1) |>
    mutate(mms_cau_c = mean(c(mms_cause_1, mms_cause_2, mms_cause_3, mms_cause_4, mms_cause_7, mms_cause_8, mms_cause_11))) |>
    mutate(mms_cau_e = mean(c(mms_cause_5, mms_cause_6, mms_cause_9, mms_cause_10))) |>
    mutate(mms_cau_n = mean(c(mms_cause_12, mms_cause_13))) |>
    rename(mms_hum = mms_human) |>
    rename(pi = pa) |>
    ungroup()

# Some participates enter age as birth year
data <- data |>
    mutate(age = ifelse(age > 1800, year(time_start) - age, age))

#### Export data ####
write_parquet(data, "data/collated/data.parquet")